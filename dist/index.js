"use strict";var p=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var v=Object.getOwnPropertyNames;var d=Object.prototype.hasOwnProperty;var V=(u,i)=>{for(var t in i)p(u,t,{get:i[t],enumerable:!0})},k=(u,i,t,n)=>{if(i&&typeof i=="object"||typeof i=="function")for(let e of v(i))!d.call(u,e)&&e!==t&&p(u,e,{get:()=>i[e],enumerable:!(n=K(i,e))||n.enumerable});return u};var B=u=>k(p({},"__esModule",{value:!0}),u);var x={};V(x,{Store:()=>b});module.exports=B(x);var y=require("events"),h=require("lmdbx"),b=class extends y.EventEmitter{constructor(t,n){super();this.flushing=!1;this.dbs=new Map,this.env=(0,h.open)(t,n),this.ttlBucket=this.env.openDB("ttl",{cache:!0})}ttlKey(t,n,e){return`${t}:${n}:${e}`}_patch(t,n){let e=t.put.bind(t),r=t.remove.bind(t),c=this;t.put=(s,o,l,f)=>{let a={};typeof l=="number"?a.version=l:typeof l=="object"&&l!==null&&(a=l);let g=e(s,o,a.version,f);if(a.ttl){let m=Date.now()+a.ttl,D=c.ttlKey(m,n,String(s));c.ttlBucket.put(D,"")}return c.emit("change",{op:"put",bucket:n,id:s,value:t.encoder.encode(o),version:a.version,ttl:a.ttl}),g},t.remove=async(s,o)=>{let l=!1,f;if(typeof o=="number"?f=o:typeof o=="object"&&o!==null&&(l=!!o.quiet,f=o.ifVersion),!l){let a=t.get(s);c.emit("change",{op:"remove",bucket:n,id:s,value:a,version:f})}return typeof o=="object"&&o!==null&&o.quiet?r(s,f):r(s,o)}}bucket(t,n){let e=this.dbs.get(t);if(!e){let r={cache:!0,...n};e=this.env.openDB(t,r),this.dbs.set(t,e),this._patch(e,t)}return e}async clean(){if(this.flushing)return;this.flushing=!0;let t=[],n=Date.now().toString();for(let e of this.ttlBucket.getKeys({end:n})){let r=e.split(":");if(r.length<3)continue;let c=r[1],s=r.slice(2).join(":");t.push({ttlKey:e,bucketName:c,id:s})}await this.env.transaction(()=>{for(let{ttlKey:e,bucketName:r,id:c}of t)this.bucket(r).remove(c,{quiet:!0}),this.ttlBucket.remove(e)}),this.flushing=!1}};0&&(module.exports={Store});
//# sourceMappingURL=index.js.map